/*
 * Copyright (C) 2015-2020, Wazuh Inc.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <cmocka.h>
#include <stdio.h>

#include "../../wazuh_modules/wmodules.h"
#include "../../headers/shared.h"
#include "mocks_wm_vuln_detector.h"

#define REPORT_CVE_VULDET_POS 0
#define REPORT_CVE_REPORT_POS 1

void wm_vuldet_init(wm_vuldet_t *vuldet);
void wm_vuldet_free_agent_software(agent_software *agent);
int wm_vuldet_get_oslinux_info(agent_software *agent);
int wm_vuldet_generate_os_and_kernel_package(sqlite3 *db, agent_software *agent);

/* setup/teardown */

static int setup_agent_software(void **state) {
    agent_software *agent = calloc(1, sizeof(agent_software));

    if(!agent) {
        return -1;
    }

    agent->agent_id = strdup("000");
    *state = agent;

    return 0;
}

static void fill_cve_report(vu_report* report, int add_title, int add_condition, int add_ip, int is_hotfix) {

    if (!report)
        return;
    
    if (1 == add_title)
        os_strdup("The CVE title.", report->title);

    if (1 == add_condition)
        os_strdup("package is less than 4.3-2", report->condition);

    if (1 == add_ip)
        os_strdup("192.168.0.125", report->agent_ip);

    os_strdup("CVE-2016-6489", report->cve);
    os_strdup("The CVE description or rationale.", report->rationale);
    os_strdup("2017-04-14", report->published);
    os_strdup("2017-07-01", report->updated);
    os_strdup("Pending confirmation", report->state);
    os_strdup("cve@mitre.org", report->assigner);
    os_strdup("4.0", report->cve_version);
    report->pending = 1;
    report->is_hotfix = is_hotfix;
    // Impact
    os_strdup(vu_severities[VU_HIGH], report->severity);
    os_calloc(1, sizeof(cv_scoring_system), report->cvss2);
    os_strdup("2.0", report->cvss2->version);
    os_strdup("AV:N/AC:M/Au:N/C:N/I:N/A:C", report->cvss2->vector_string);
    report->cvss2->impact_score = 6.9;
    report->cvss2->exploitability_score = 8.6;
    report->cvss2->base_score = 7.1;
    os_calloc(1, sizeof(cv_scoring_system), report->cvss3);
    os_strdup("3.0", report->cvss3->version);
    os_strdup("CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H", report->cvss3->vector_string);
    report->cvss3->impact_score = 3.6;
    report->cvss3->exploitability_score = 2.2;
    report->cvss3->base_score = 5.9;
    os_strdup("CWE-502", report->cwe);
    // References
    os_realloc(report->advisories, 2 * sizeof(char *), report->advisories);
    os_strdup("RHSA-2020:0975", report->advisories[0]);
    report->advisories[1] = NULL;
    os_realloc(report->bugzilla_references, 2 * sizeof(char *), report->bugzilla_references);
    os_strdup("http://rhn.redhat.org/cgi-bin/bugreport.cgi?bug=925286", report->bugzilla_references[0]);
    report->bugzilla_references[1] = NULL;
    os_realloc(report->references, 2 * sizeof(char *), report->references);
    os_strdup("http://rhn.redhat.com/errata/RHSA-2016-2582.html", report->references[0]);
    report->references[1] = NULL;
    os_realloc(report->ref_sources, 2 * sizeof(char *), report->ref_sources);
    os_strdup("REDHAT", report->ref_sources[0]);
    report->ref_sources[1] = NULL;
    // Reported software
    os_strdup("libhogweed4", report->software);
    os_strdup("nettle", report->source);
    os_strdup("o:microsoft:windows_server_2008:r2:sp1::::::", report->generated_cpe);
    os_strdup("3.4-1", report->version);
    os_strdup("CVE-2016-6489 reports as vulnerable all the versions of this package", report->operation);
    os_strdup("4.3-2", report->operation_value);
    os_strdup("amd64", report->arch);
    // Agent data
    os_strdup("001", report->agent_id);
    os_strdup("Ubuntu_WAgent", report->agent_name);

    return;
}

static int setup_cve_report(void **state) {
    wm_vuldet_t *vuldet = calloc(1, sizeof(wm_vuldet_t));

    if (!vuldet) {
        return -1;
    }

    state[REPORT_CVE_VULDET_POS] = vuldet;
    vuldet->flags.enabled = 1;
    vuldet->flags.run_on_start = 1;

    will_return(__wrap_StartMQ, 1);
    will_return_always(__wrap_OPENSSL_init_ssl, 1);
    will_return(__wrap_OPENSSL_init_crypto, 1);

    wm_vuldet_init(vuldet);

    vu_report *report = calloc(1, sizeof(vu_report));

    if(!report) {
        os_free(vuldet);
        return -1;
    }

    state[REPORT_CVE_REPORT_POS] = report;
    wm_max_eps = 1000000;

    return 0;
}

static int teardown_agent_software(void **state) {
    agent_software *agent = *state;

    if(agent) {
        wm_vuldet_free_agent_software(agent);
    }

    return 0;
}

static int teardown_cve_report(void **state) {
    wm_vuldet_t *vuldet = state[REPORT_CVE_VULDET_POS];
    vu_report *report = state[REPORT_CVE_REPORT_POS];

    if(vuldet) {
        os_free(vuldet);
    }

    if(report) {
        wm_vuldet_free_report(report);
    }

    return 0;
}

/* tests */

void test_wm_vuldet_get_oslinux_info(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_VERSION, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    char *response = "ok [{\"os_version\":\"10.0.1\",\"release\":\"4.5.1\"}]";
    size_t response_size = strlen(response) + 1;

    expect_string(__wrap_OS_ConnectUnixDomain, path, WDB_LOCAL_SOCK_PATH);
    expect_value(__wrap_OS_ConnectUnixDomain, type, SOCK_STREAM);
    expect_value(__wrap_OS_ConnectUnixDomain, max_msg_size, OS_SIZE_6144);
    will_return(__wrap_OS_ConnectUnixDomain, 11111);

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, response);
    will_return(__wrap_OS_RecvSecureTCP, response_size);

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, 0);
    assert_string_equal(agent->os_release, "10.0.1");
    assert_string_equal(agent->kernel_release, "4.5.1");
}

void test_wm_vuldet_get_oslinux_info_only_version(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_VERSION, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    char *response = "ok [{\"os_version\":\"10.0.1 LTS\"}]";
    size_t response_size = strlen(response) + 1;

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, response);
    will_return(__wrap_OS_RecvSecureTCP, response_size);

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, 0);
    assert_string_equal(agent->os_release, "10.0.1");
    assert_null(agent->kernel_release);
}

void test_wm_vuldet_get_oslinux_info_only_release(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_VERSION, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    char *response = "ok [{\"release\":\"4.5.1\"}]";
    size_t response_size = strlen(response) + 1;

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, response);
    will_return(__wrap_OS_RecvSecureTCP, response_size);

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, 0);
    assert_null(agent->os_release);
    assert_string_equal(agent->kernel_release, "4.5.1");
}

void test_wm_vuldet_get_oslinux_info_null_agent(void **state)
{
    (void) state;

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5580): The agent structure is not initialized.");

    int ret = wm_vuldet_get_oslinux_info(NULL);

    assert_int_equal(ret, -1);
}

void test_wm_vuldet_get_oslinux_info_request_invalid(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_VERSION, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, "");
    will_return(__wrap_OS_RecvSecureTCP, 0);

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5582): Couldn't get the OS information of the agent 000.");

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, -1);
    assert_null(agent->os_release);
    assert_null(agent->kernel_release);
}

void test_wm_vuldet_get_oslinux_info_request_error(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_VERSION, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    expect_string(__wrap_OS_ConnectUnixDomain, path, WDB_LOCAL_SOCK_PATH);
    expect_value(__wrap_OS_ConnectUnixDomain, type, SOCK_STREAM);
    expect_value(__wrap_OS_ConnectUnixDomain, max_msg_size, OS_SIZE_6144);
    will_return(__wrap_OS_ConnectUnixDomain, 11111);

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, "err");
    will_return(__wrap_OS_RecvSecureTCP, 3);

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5502): Invalid response from wazuh-db: 'err'.");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5582): Couldn't get the OS information of the agent 000.");

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, -1);
    assert_null(agent->os_release);
    assert_null(agent->kernel_release);
}

void test_wm_vuldet_get_oslinux_info_request_empty(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_VERSION, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, "ok []");
    will_return(__wrap_OS_RecvSecureTCP, 5);

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, 0);
    assert_null(agent->os_release);
    assert_null(agent->kernel_release);
}

void test_wm_vuldet_get_oslinux_info_request_parse_error(void **state)
{
    agent_software *agent = *state;

    const char *query = "agent 000 sql SELECT OS_VERSION, RELEASE FROM SYS_OSINFO;";
    size_t query_size = strlen(query) + 1;

    expect_value(__wrap_OS_SendSecureTCP, sock, 11111);
    expect_value(__wrap_OS_SendSecureTCP, size, query_size);
    expect_string(__wrap_OS_SendSecureTCP, msg, query);
    will_return(__wrap_OS_SendSecureTCP, 0);

    expect_value(__wrap_OS_RecvSecureTCP, sock, 11111);
    expect_value(__wrap_OS_RecvSecureTCP, size, OS_SIZE_128);
    will_return(__wrap_OS_RecvSecureTCP, "ok answer");
    will_return(__wrap_OS_RecvSecureTCP, 9);

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5582): Couldn't get the OS information of the agent 000.");

    int ret = wm_vuldet_get_oslinux_info(agent);

    assert_int_equal(ret, -1);
    assert_null(agent->os_release);
    assert_null(agent->kernel_release);
}

void test_wm_vuldet_generate_os_and_kernel_package_ubuntu(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    agent->dist = FEED_UBUNTU;
    agent->dist_ver = FEED_BIONIC;
    agent->os_release = strdup("18.04");
    agent->kernel_release = strdup("3.10");
    agent->arch = strdup("x86_64");

    will_return_count(__wrap_sqlite3_prepare_v2, SQLITE_OK, 2);
    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    will_return_count(__wrap_sqlite3_step, SQLITE_DONE, 2);

    // OS package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "canonical");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "ubuntu_linux");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "18.04");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    // Kernel package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "linux");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "linux_kernel");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "3.10");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, 0);
}

void test_wm_vuldet_generate_os_and_kernel_package_debian(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    agent->dist = FEED_DEBIAN;
    agent->dist_ver = FEED_BUSTER;
    agent->os_release = strdup("10");
    agent->kernel_release = strdup("4.11");
    agent->arch = strdup("x86_64");

    will_return_count(__wrap_sqlite3_prepare_v2, SQLITE_OK, 2);
    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    will_return_count(__wrap_sqlite3_step, SQLITE_DONE, 2);

    // OS package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "debian");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "debian_linux");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "10");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    // Kernel package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "linux");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "linux_kernel");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "4.11");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, 0);
}

void test_wm_vuldet_generate_os_and_kernel_package_redhat(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    agent->dist = FEED_REDHAT;
    agent->dist_ver = FEED_RHEL7;
    agent->os_release = strdup("7.2");
    agent->kernel_release = strdup("5.1.0");
    agent->arch = strdup("x86_64");

    will_return_count(__wrap_sqlite3_prepare_v2, SQLITE_OK, 2);
    will_return_always(__wrap_sqlite3_bind_text, 0);
    will_return_always(__wrap_sqlite3_bind_int, 0);
    will_return_count(__wrap_sqlite3_step, SQLITE_DONE, 2);

    // OS package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "redhat");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "enterprise_linux");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "7.2");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    // Kernel package
    expect_value(__wrap_sqlite3_bind_text, a, 1);
    expect_string(__wrap_sqlite3_bind_text, b, "000");
    expect_value(__wrap_sqlite3_bind_text, a, 2);
    expect_value(__wrap_sqlite3_bind_text, a, 3);
    expect_value(__wrap_sqlite3_bind_int, a, 4);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    expect_value(__wrap_sqlite3_bind_text, a, 5);
    expect_string(__wrap_sqlite3_bind_text, b, "linux");
    expect_value(__wrap_sqlite3_bind_text, a, 6);
    expect_string(__wrap_sqlite3_bind_text, b, "linux_kernel");
    expect_value(__wrap_sqlite3_bind_text, a, 7);
    expect_value(__wrap_sqlite3_bind_text, a, 8);
    expect_string(__wrap_sqlite3_bind_text, b, "5.1.0");
    expect_value(__wrap_sqlite3_bind_text, a, 9);
    expect_string(__wrap_sqlite3_bind_text, b, "x86_64");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, 0);
}

void test_wm_vuldet_generate_os_and_kernel_package_null_db(void **state)
{
    (void) state;

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5581): The DB is not initialized.");

    int ret = wm_vuldet_generate_os_and_kernel_package(NULL, NULL);

    assert_int_equal(ret, -1);
}

void test_wm_vuldet_generate_os_and_kernel_package_null_agent(void **state)
{
    (void) state;
    sqlite3 *db = (sqlite3 *)1;

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5580): The agent structure is not initialized.");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, NULL);

    assert_int_equal(ret, -1);
}

void test_wm_vuldet_generate_os_and_kernel_package_invalid_agent(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5549): Could not get the agent 000 os_version nor release, so its OS and kernel vulnerabilities will not be analysed. It may not have os_info scan activated.");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, 1);
}

void test_wm_vuldet_generate_os_and_kernel_package_os_package_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    agent->dist = FEED_REDHAT;
    agent->dist_ver = FEED_RHEL7;
    agent->os_release = strdup("7.2");
    agent->arch = strdup("x86_64");

    // OS package
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    will_return(__wrap_sqlite3_errmsg, "error");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5405): SQL error: error");

    will_return(__wrap_sqlite3_close_v2, 0);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5567): It was not possible to insert enterprise_linux in the agent software table.");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, -1);
}

void test_wm_vuldet_generate_os_and_kernel_package_kernel_package_error(void **state)
{
    agent_software *agent = *state;
    sqlite3 *db = (sqlite3 *)1;

    agent->dist = FEED_REDHAT;
    agent->dist_ver = FEED_RHEL7;
    agent->kernel_release = strdup("5.1.0");
    agent->arch = strdup("x86_64");

    // Kernel package
    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);

    will_return(__wrap_sqlite3_errmsg, "error");

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5405): SQL error: error");

    will_return(__wrap_sqlite3_close_v2, 0);

    expect_string(__wrap__mtdebug1, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug1, formatted_msg, "(5567): It was not possible to insert linux_kernel in the agent software table.");

    int ret = wm_vuldet_generate_os_and_kernel_package(db, agent);

    assert_int_equal(ret, -1);
}

void test_wm_vuldet_send_cve_report_error_alert_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    will_return(__wrap_cJSON_CreateObject, NULL);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, -1);
}

void test_wm_vuldet_send_cve_report_error_alert_cve_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, NULL);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, -1);
}

void test_wm_vuldet_send_cve_report_error_j_package_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, NULL);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, -1);
}

void test_wm_vuldet_send_cve_report_error_j_cvss_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    fill_cve_report(report, 1, 1, 1, 1);

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_package = (cJSON*)__real_cJSON_CreateObject();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, j_package);
    will_return(__wrap_cJSON_CreateObject, NULL);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, -1);
}

void test_wm_vuldet_send_cve_report_error_j_cvss_node_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    fill_cve_report(report, 1, 1, 1, 1);

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_package = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss = (cJSON*)__real_cJSON_CreateObject();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, j_package);
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    will_return(__wrap_cJSON_CreateObject, NULL);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, -1);
}

void test_wm_vuldet_send_cve_report_error_j_advisories_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    fill_cve_report(report, 1, 1, 1, 1);

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_package = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json2 = (cJSON*)__real_cJSON_CreateObject();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, j_package);
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node1);
    will_return(__wrap_cJSON_CreateObject, cvss_json1);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node2);
    will_return(__wrap_cJSON_CreateObject, cvss_json2);
    will_return(__wrap_cJSON_CreateArray, NULL);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, -1);
}

void test_wm_vuldet_send_cve_report_error_j_bug_references_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    fill_cve_report(report, 1, 1, 1, 1);

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_package = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_advisories = (cJSON*)__real_cJSON_CreateArray();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, j_package);
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node1);
    will_return(__wrap_cJSON_CreateObject, cvss_json1);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node2);
    will_return(__wrap_cJSON_CreateObject, cvss_json2);
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    will_return(__wrap_cJSON_CreateArray, NULL);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, -1);
}

void test_wm_vuldet_send_cve_report_error_j_references_create(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    fill_cve_report(report, 1, 1, 1, 1);

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_package = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_advisories = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_bug_references = (cJSON*)__real_cJSON_CreateArray();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, j_package);
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node1);
    will_return(__wrap_cJSON_CreateObject, cvss_json1);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node2);
    will_return(__wrap_cJSON_CreateObject, cvss_json2);
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    will_return(__wrap_cJSON_CreateArray, j_bug_references);
    will_return(__wrap_cJSON_CreateArray, NULL);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, -1);
}

void test_wm_vuldet_send_cve_report_without_title(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    // If we dont have a title, the rationale value should be used
    fill_cve_report(report, 0, 1, 1, 1);

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_package = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_advisories = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_bug_references = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_references = (cJSON*)__real_cJSON_CreateArray();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, j_package);
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node1);
    will_return(__wrap_cJSON_CreateObject, cvss_json1);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node2);
    will_return(__wrap_cJSON_CreateObject, cvss_json2);
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    will_return(__wrap_cJSON_CreateArray, j_bug_references);
    will_return(__wrap_cJSON_CreateArray, j_references);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5533): Agent 001 is vulnerable to CVE-2016-6489. Condition: package is less than 4.3-2");

    will_return(__wrap_SendMSG, 1);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, 0);
}

void test_wm_vuldet_send_cve_report_without_condition(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    // If we dont have a condition, the condition should be created
    // by using the operation and operation_value fields.
    fill_cve_report(report, 1, 0, 1, 1);

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_package = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_advisories = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_bug_references = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_references = (cJSON*)__real_cJSON_CreateArray();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, j_package);
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node1);
    will_return(__wrap_cJSON_CreateObject, cvss_json1);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node2);
    will_return(__wrap_cJSON_CreateObject, cvss_json2);
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    will_return(__wrap_cJSON_CreateArray, j_bug_references);
    will_return(__wrap_cJSON_CreateArray, j_references);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5533): Agent 001 is vulnerable to CVE-2016-6489. Condition: Package CVE-2016-6489 reports as vulnerable all the versions of this package 4.3-2");

    will_return(__wrap_SendMSG, 1);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, 0);
}

void test_wm_vuldet_send_cve_report_without_ip(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    // If we dont have an IP address, this will variate the alert message.
    fill_cve_report(report, 1, 1, 0, 1);

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_package = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_advisories = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_bug_references = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_references = (cJSON*)__real_cJSON_CreateArray();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, j_package);
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node1);
    will_return(__wrap_cJSON_CreateObject, cvss_json1);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node2);
    will_return(__wrap_cJSON_CreateObject, cvss_json2);
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    will_return(__wrap_cJSON_CreateArray, j_bug_references);
    will_return(__wrap_cJSON_CreateArray, j_references);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5533): Agent 001 is vulnerable to CVE-2016-6489. Condition: package is less than 4.3-2");

    will_return(__wrap_SendMSG, 1);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, 0);
}

void test_wm_vuldet_send_cve_report_without_hotfix(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    // If we dont have a hotfix, this will variate the message log.
    fill_cve_report(report, 1, 1, 1, 0);

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_package = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_advisories = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_bug_references = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_references = (cJSON*)__real_cJSON_CreateArray();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, j_package);
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node1);
    will_return(__wrap_cJSON_CreateObject, cvss_json1);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node2);
    will_return(__wrap_cJSON_CreateObject, cvss_json2);
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    will_return(__wrap_cJSON_CreateArray, j_bug_references);
    will_return(__wrap_cJSON_CreateArray, j_references);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5467): The 'libhogweed4' package from agent 001 is vulnerable to CVE-2016-6489. Condition: package is less than 4.3-2.");

    will_return(__wrap_SendMSG, 1);

    int retval = wm_vuldet_send_cve_report(report);

    assert_int_equal(retval, 0);
}

void test_wm_vuldet_send_cve_report_sendmsg_error(void **state)
{
    vu_report* report = state[REPORT_CVE_REPORT_POS];

    // If we dont have a hotfix, this will variate the message log.
    fill_cve_report(report, 1, 1, 1, 0);

    cJSON* alert = (cJSON*)__real_cJSON_CreateObject();
    cJSON* alert_cve = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_package = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json1 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_cvss_node2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* cvss_json2 = (cJSON*)__real_cJSON_CreateObject();
    cJSON* j_advisories = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_bug_references = (cJSON*)__real_cJSON_CreateArray();
    cJSON* j_references = (cJSON*)__real_cJSON_CreateArray();
    will_return(__wrap_cJSON_CreateObject, alert);
    will_return(__wrap_cJSON_CreateObject, alert_cve);
    will_return(__wrap_cJSON_CreateObject, j_package);
    will_return(__wrap_cJSON_CreateObject, j_cvss);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node1);
    will_return(__wrap_cJSON_CreateObject, cvss_json1);
    will_return(__wrap_cJSON_CreateObject, j_cvss_node2);
    will_return(__wrap_cJSON_CreateObject, cvss_json2);
    will_return(__wrap_cJSON_CreateArray, j_advisories);
    will_return(__wrap_cJSON_CreateArray, j_bug_references);
    will_return(__wrap_cJSON_CreateArray, j_references);

    expect_string(__wrap__mtdebug2, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mtdebug2, formatted_msg, "(5467): The 'libhogweed4' package from agent 001 is vulnerable to CVE-2016-6489. Condition: package is less than 4.3-2.");

    will_return(__wrap_SendMSG, -1);

    char* strerr = NULL;
    os_strdup("Error sending message", strerr);
    will_return(__wrap_strerror, strerr);

    expect_string(__wrap__merror, formatted_msg, "At wm_sendmsg(): Unable to send message to queue: (Error sending message)");

    will_return(__wrap_strerror, strerr);
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(1210): Queue '/queue/ossec/queue' not accessible: 'Error sending message'.");

    will_return(__wrap_StartMQ, -1);

    expect_string(__wrap__mterror_exit, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror_exit, formatted_msg, "(1211): Unable to access queue: '/queue/ossec/queue'. Giving up..");

    int retval = wm_vuldet_send_cve_report(report);
    
    os_free(strerr);

    assert_int_equal(retval, 0);
}

int main(void) {
    const struct CMUnitTest tests[] = {
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_only_version, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_only_release, setup_agent_software, teardown_agent_software),
        cmocka_unit_test(test_wm_vuldet_get_oslinux_info_null_agent),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_request_invalid, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_request_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_request_empty, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_get_oslinux_info_request_parse_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_ubuntu, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_debian, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_redhat, setup_agent_software, teardown_agent_software),
        cmocka_unit_test(test_wm_vuldet_generate_os_and_kernel_package_null_db),
        cmocka_unit_test(test_wm_vuldet_generate_os_and_kernel_package_null_agent),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_invalid_agent, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_os_package_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_generate_os_and_kernel_package_kernel_package_error, setup_agent_software, teardown_agent_software),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_alert_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_alert_cve_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_package_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_cvss_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_cvss_node_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_advisories_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_bug_references_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_error_j_references_create, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_without_title, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_without_condition, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_without_ip, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_without_hotfix, setup_cve_report, teardown_cve_report),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_send_cve_report_sendmsg_error, setup_cve_report, teardown_cve_report)
    };
    return cmocka_run_group_tests(tests, NULL, NULL);
}