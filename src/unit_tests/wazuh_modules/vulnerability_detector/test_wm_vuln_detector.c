/*
 * Copyright (C) 2015-2020, Wazuh Inc.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <cmocka.h>
#include <stdio.h>

#include "../wazuh_modules/wmodules.h"


int pkg_version_compare(const struct pkg_version *a, const struct pkg_version *b);
bool pkg_version_relate(const struct pkg_version *a, enum pkg_relation rel, const struct pkg_version *b, version_type vertype);

/* setup/teardown */

static int setup_versions(void **state) {
    struct pkg_version *version_a;
    struct pkg_version *version_b;

    os_calloc(1, sizeof(version_a), version_a);
    os_calloc(1, sizeof(version_b), version_b);

    if(!version_a || !version_b) {
        return -1;
    }

    state[0] = version_a;
    state[1] = version_b;

    return 0;
}

static int teardown_versions(void **state) {
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    if(version_a) {
        free(version_a);
    }

    if(version_b) {
        free(version_b);
    }

    return 0;
}

/* redefinitons/wrapping */

int __wrap_close() {
    return 1;
}

/* tests */

void test_pkg_version_relate_epoch(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 1;
    version_a->version = "";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_NONE, version_b, VER_TYPE_NONE);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_version_deb(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);

    version_a->version = "4.18.1";
    version_b->version = "5.3.0.45";

    ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_version_rpm(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);

    version_a->version = "4.18.1";
    version_b->version = "5.3.0.45";

    ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_revision_deb(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "2+2ubuntu1.2";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2+2ubuntu1.1";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);

    version_a->revision = "2+2ubuntu1.1";
    version_b->revision = "2+2ubuntu1.2";

    ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_revision_rpm(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "12.9";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2.el8";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);

    version_a->revision = "2.el8";
    version_b->revision = "12.9";

    ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
    ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
    ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
}

int main(void) {
    const struct CMUnitTest tests[] = {
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_epoch, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_deb, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_rpm, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_deb, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_rpm, setup_versions, teardown_versions)
    };
    return cmocka_run_group_tests(tests, NULL, NULL);
}