/*
 * Copyright (C) 2015-2020, Wazuh Inc.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <cmocka.h>
#include <stdio.h>

#include "../../wazuh_modules/wmodules.h"
#include "../../headers/shared.h"
 #include "mocks_wm_vuln_detector.h"

void wm_vuldet_free_agent_software(agent_software *agent);

char *wm_vuldet_clean_version(const char *version);
bool wm_vuldet_check_generic_package(char * agent_id, sqlite3_stmt * package, sqlite3 * dbCVE, OSHash * cve_table ,int8_t name_type);
bool wm_vuldet_check_specific_package(char * agent_id, sqlite3_stmt * package, sqlite3 * dbCVE, OSHash * cve_table, int8_t name_type);
int wm_vuldet_get_children(sqlite3 * dbCVE, int configuration_id, int package_id, int *children);
int wm_vuldet_get_siblings(sqlite3 * dbCVE, int parent, int configuration_id, int *siblings);

/* setup */

static int setup_version(void **state) {
    char *version;

    os_calloc(1, sizeof(char*), version);

    if(!version) {
        return -1;
    }

    state[0] = version;

    return 0;
}

static int setup_agent_software(void **state) {
    agent_software *agent = calloc(1, sizeof(agent_software));

    if(!agent) {
        return -1;
    }

    agent->agent_id = strdup("000");
    *state = agent;

    return 0;
}

/* setup/teardown */

static int teardown_version(void **state) {
    char *version = state[0];

    if(version) {
        free(version);
    }

    return 0;
}

static int teardown_agent_software(void **state) {
    agent_software *agent = *state;

    if(agent) {
        wm_vuldet_free_agent_software(agent);
    }

    return 0;
}

/* tests */

/* wm_vuldet_clean_version */

void test_wm_vuldet_clean_version_complete(void **state)
{
    char *version = state[0];

    version = strdup("1:test-release");

    char* ret = wm_vuldet_clean_version(version);
    assert_string_equal(ret, "test");
}

void test_wm_vuldet_clean_version_no_epoch(void **state)
{
    char *version = state[0];

    version = strdup("test-release");

    char* ret = wm_vuldet_clean_version(version);
    assert_string_equal(ret, "test");
}

void test_wm_vuldet_clean_version_no_release(void **state)
{
    char *version = state[0];

    version = strdup("1:test");

    char* ret = wm_vuldet_clean_version(version);
    assert_string_equal(ret, "test");
}

void test_wm_vuldet_clean_version_no_epoch_release(void **state)
{
    char *version = state[0];

    version = strdup("test");

    char* ret = wm_vuldet_clean_version(version);
    assert_string_equal(ret, "test");
}

/* wm_vuldet_get_children */

void test_wm_vuldet_get_children_prepare_error(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    int configuration_id = 0;
    int package_id = 0;
    int *children = NULL;

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_ERROR);
    will_return(__wrap_sqlite3_errmsg, "error");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5571): Couldn't get from the NVD the 'children' dependencies of the package with ID '0'");
    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "(5503): SQL error: 'error'");

    will_return(__wrap_sqlite3_close_v2, SQLITE_OK);

    int ret = wm_vuldet_get_children(db, configuration_id, package_id, children);
    assert_int_equal(ret, -1);
}

void test_wm_vuldet_get_children_done(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    int configuration_id = 0;
    int package_id = 0;
    int *children = NULL;

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    will_return(__wrap_sqlite3_bind_int, 0);
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    will_return(__wrap_sqlite3_bind_int, 0);

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_get_children(db, configuration_id, package_id, children);
    assert_int_equal(ret, 0);
}

void test_wm_vuldet_get_children_OK(void **state)
{
    sqlite3 *db = (sqlite3 *)1;
    int configuration_id = 0;
    int package_id = 0;

    int *children = NULL;
    os_calloc(1, sizeof(int), children);
    if(!children)
        return;

    will_return(__wrap_sqlite3_prepare_v2, SQLITE_OK);

    expect_value(__wrap_sqlite3_bind_int, a, 1);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    will_return(__wrap_sqlite3_bind_int, 0);
    expect_value(__wrap_sqlite3_bind_int, a, 2);
    expect_value(__wrap_sqlite3_bind_int, b, 0);
    will_return(__wrap_sqlite3_bind_int, 0);

    will_return(__wrap_sqlite3_step, SQLITE_ROW);

    expect_value(__wrap_sqlite3_column_int, i, 0);
    will_return(__wrap_sqlite3_column_int, 1);

    will_return(__wrap_sqlite3_step, SQLITE_DONE);

    int ret = wm_vuldet_get_children(db, configuration_id, package_id, children);
    assert_int_equal(ret, 0);
}

/* Tests */

int main(void) {
    const struct CMUnitTest tests[] = {
        cmocka_unit_test_setup_teardown(test_wm_vuldet_clean_version_complete, setup_version, teardown_version),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_clean_version_no_epoch, setup_version, teardown_version),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_clean_version_no_release, setup_version, teardown_version),
        cmocka_unit_test_setup_teardown(test_wm_vuldet_clean_version_no_epoch_release, setup_version, teardown_version),
        cmocka_unit_test(test_wm_vuldet_get_children_prepare_error),
        cmocka_unit_test(test_wm_vuldet_get_children_done),
        cmocka_unit_test(test_wm_vuldet_get_children_OK)
    };
    return cmocka_run_group_tests(tests, NULL, NULL);
}
