#include "../external/wazuh_tools.h"

#define MAX_SIZE 6144
#define NVD_DB "nvd.db"

/* Data structure
 *
 * All nvd structures are linked list
 *
 */
typedef struct nvd_references {
    char *url;
    char *refsource;
    struct nvd_references *next;
} nvd_references;
typedef struct nvd_references * pnvd_references;

typedef struct nvd_conf_cpe_match {
    int vulnerable;
    char *cpe_uri23;
    char *version_start_including;
    char *version_start_excluding;
    char *version_end_including;
    char *version_end_excluding;
    struct nvd_conf_cpe_match *next;
} nvd_conf_cpe_match;
typedef struct nvd_conf_cpe_match * pnvd_conf_cpe_match;

typedef struct nvd_configuration {
    char *operator;
    struct nvd_configuration *children;
    pnvd_conf_cpe_match cpe_matches;
    struct nvd_configuration *next;
} nvd_configuration;
typedef struct nvd_configuration * pnvd_configuration;

typedef struct cv_scoring_system {
    char *version;
    char *vector_string;
    float base_score;
    float exploitability_score;
    float impact_score;
} cv_scoring_system;
typedef struct cv_scoring_system * pcv_scoring_system;

typedef struct nvd {
    char *id;
    char *cwe;
    char *description;
    pnvd_references references;
    pnvd_configuration configuration;
    pcv_scoring_system cvss2;
    pcv_scoring_system cvss3;
    char *published;
    char *last_modified;
    struct nvd *next;
} nvd;
typedef struct nvd * pnvd;

extern const char *cpe_schema;

// Function declaration
cJSON * read_nvd_file();
int nvd_database_create();
nvd * parse_nvd_json(cJSON *nvd_json);
int parse_nvd_cve(cJSON *cve, pnvd data);
int parse_nvd_configuration(cJSON *configuration, pnvd data);
int parse_nvd_configuration_node(cJSON *conf_element, pnvd_configuration conf);
int parse_nvd_impact(cJSON *impact, pnvd data);
void free_nvd(pnvd data);


//Cleaning structures
void free_nvd_references(pnvd_references data) {
}

void free_nvd_conf_cpe_match(pnvd_conf_cpe_match data) {
}

void free_nvd_configuration(pnvd_configuration data) {
}

void free_cv_scoring_system(pcv_scoring_system data) {
}

void free_nvd(pnvd data) {
    free_nvd_references(data->references);
    free_nvd_conf_cpe_match(data->configuration->cpe_matches);
    free_nvd_configuration(data->configuration);
    free_cv_scoring_system(data->cvss2);
    free_cv_scoring_system(data->cvss3);
    os_free(data->published);
    os_free(data->last_modified);
}


//Implementation
int nvd_database_create() {
    if (wm_vuldet_create_file(NVD_DB, cpe_schema)) {
        printf("Could not create the database\n");
        return -1;
    }

    return 0;
}

// Return NULL on error
cJSON * read_nvd_file() {
    cJSON *json_feed = NULL;

    if (json_feed =  json_fread("./nvdcve-1.0-2014.json", 0), !json_feed) {
        printf("Error reading nvd file\n");
    }

    return json_feed;
}

nvd * parse_nvd_json(cJSON *nvd_json) {
    cJSON *nvd_data;
    cJSON *cve_list;
    cJSON *cve_data;
    pnvd nvd_list;
    pnvd nvd_node = NULL;

    os_calloc(1, sizeof(pnvd), nvd_list);
    nvd_node = nvd_list;

    for (nvd_data = nvd_json->child; nvd_data; nvd_data = nvd_data->next) {
        //printf("cve_list: '%s'\n", nvd_data->string);

        if (!strcmp(nvd_data->string, "CVE_Items")) {
            for (cve_list = nvd_data->child; cve_list; cve_list = cve_list->next) {

                for (cve_data = cve_list->child; cve_data; cve_data = cve_data->next) {
                    //printf("'%s': '%s'\n", cve_data->string, cve_data->valuestring);
                    if (!strcmp(cve_data->string, "cve")) {
                        parse_nvd_cve(cve_data, nvd_node);
                    } else if (!strcmp(cve_data->string, "configurations")) {
                        parse_nvd_configuration(cve_data, nvd_node);
                    } else if (!strcmp(cve_data->string, "impact")) {
                        parse_nvd_impact(cve_data, nvd_node);
                    } else if (!strcmp(cve_data->string, "publishedDate")) {
                        os_strdup(cve_data->valuestring, nvd_node->published);
                    } else if (!strcmp(cve_data->string, "lastModifiedDate")) {
                        os_strdup(cve_data->valuestring, nvd_node->last_modified);
                    }
                }
                //printf("\n\n\n");
                os_calloc(1, sizeof(pnvd), nvd_node->next);
                nvd_node = nvd_node->next;
            }
        }
    }

    return nvd_list;
}

int parse_nvd_cve(cJSON *cves, pnvd data) {
    cJSON *cve_item;
    cJSON *cve_element;
    pnvd_references ref_node = NULL;

    os_calloc(1, sizeof(pnvd_references), data->references);
    memset(data->references, '\0', sizeof(pnvd_references));
    ref_node = data->references;

    for (cve_item = cves->child; cve_item; cve_item = cve_item->next) {
        //printf("parse_nvd_cve: '%s'\n", cve_item->string);
        if (!strcmp(cve_item->string, "CVE_data_meta")) {
            printf("\n\n'%s': '%s'\n", cve_item->child->string, cve_item->child->valuestring);
            os_strdup(cve_item->child->valuestring, data->id);
        } else if (!strcmp(cve_item->string, "problemtype") && cve_item->child->child->child->next) {
            //printf ("cwe: '%s'\n", cve_item->child->child->child->child->child->next ? cve_item->child->child->child->child->child->next->valuestring : "CWE not found");
            os_strdup(cve_item->child->child->child->child->child->next->valuestring, data->cwe);
        } else if (!strcmp(cve_item->string, "references")) {
            //printf ("\nnvd_cve: '%s'\n", cve_item->string);

            for (cve_element = cve_item->child->child; cve_element; cve_element = cve_element->next) {
                //printf ("'%s': '%s'\n", cve_element->child->string, cve_element->child->valuestring);
                //printf ("'%s': '%s'\n", cve_element->child->next->next->string, cve_element->child->next->next->valuestring);
                os_strdup(cve_element->child->valuestring, ref_node->url);
                os_strdup(cve_element->child->next->next->valuestring, ref_node->refsource);

                os_calloc(1, sizeof(pnvd_references), ref_node->next);
                ref_node = ref_node->next;
            }
        }
    }

    return 0;
}

int parse_nvd_configuration(cJSON *nvd_item, pnvd data) {
    cJSON *conf_item;
    pnvd_configuration conf_node = NULL;

    os_calloc(1, sizeof(nvd_configuration), data->configuration);
    conf_node = data->configuration;

    for (conf_item = nvd_item->child; conf_item; conf_item = conf_item->next) {
        //printf ("conf_item: '%s'\n", conf_item->string);
        if (!strcmp(conf_item->string, "nodes")) {
            parse_nvd_configuration_node(conf_item, data->configuration);
        }
    }

    return 0;
}

int parse_nvd_configuration_node(cJSON *configurations, pnvd_configuration conf) {
    cJSON *conf_element;
    cJSON *conf_node;
    cJSON *cpe_match_item;
    cJSON *cpe_match_element;
    pnvd_conf_cpe_match cpe_match_node = NULL;

    os_calloc(1, sizeof(nvd_conf_cpe_match), conf->cpe_matches);
    cpe_match_node = conf->cpe_matches;

    for (conf_element = configurations->child; conf_element; conf_element = conf_element->next) {

        for (conf_node = conf_element->child; conf_node; conf_node = conf_node->next) {
            printf ("'%s': '%s'\n", conf_node->string, conf_node->valuestring);

            if (!strcmp(conf_node->string, "operator")) {
                //printf ("operator: '%s'\n", conf_node->child->valuestring);
                conf->operator = conf_node->valuestring;
            }

            if (!strcmp(conf_node->string, "children")) {
                //Parsing AND node
                os_calloc(1, sizeof(nvd_configuration), conf->children);
                parse_nvd_configuration_node(conf_node, conf->children);
            }

            if (!strcmp(conf_node->string, "cpe_match")) {

                for (cpe_match_item = conf_node->child; cpe_match_item; cpe_match_item = cpe_match_item->next) {

                    for(cpe_match_element = cpe_match_item->child; cpe_match_element; cpe_match_element = cpe_match_element->next) {

                        //printf("cpe_match_element: '%s'\n", cpe_match_element? cpe_match_element->string : "\0");

                        if (!strcmp(cpe_match_element->string, "vulnerable")) {
                            cpe_match_node->vulnerable = cpe_match_element->valueint;
                        } else if (!strcmp(cpe_match_element->string, "cpe23Uri")) {
                            os_strdup(cpe_match_element->valuestring, cpe_match_node->cpe_uri23);
                        } else if (!strcmp(cpe_match_element->string, "versionStartIncluding")) {
                            os_strdup(cpe_match_element->valuestring, cpe_match_node->version_end_including);
                        } else if (!strcmp(cpe_match_element->string, "versionEndIncluding")) {
                            os_strdup(cpe_match_element->valuestring, cpe_match_node->version_end_including);
                        } else if (!strcmp(cpe_match_element->string, "versionStartExcluding")) {
                            os_strdup(cpe_match_element->valuestring, cpe_match_node->version_end_including);
                        } else if (!strcmp(cpe_match_element->string, "versionEndExcluding")) {
                            os_strdup(cpe_match_element->valuestring, cpe_match_node->version_end_including);
                        }
                    }

                    os_calloc(1, sizeof(nvd_conf_cpe_match), cpe_match_node->next);
                    cpe_match_node = cpe_match_node->next;
                }
            }
        }
    }

    return 0;
}

int parse_nvd_impact(cJSON *nvd_item, pnvd data) {
    cJSON *impact_item;
    cJSON *impact_element;
    cJSON *cvss_data;
    pcv_scoring_system scoring;

    for (impact_item = nvd_item->child; impact_item; impact_item = impact_item->next) {
        printf ("\nimpact_item: '%s'\n", impact_item->string);

        os_calloc(1, sizeof(cv_scoring_system), scoring);
        for (impact_element = impact_item->child; impact_element; impact_element = impact_element->next) {
            printf ("impact_element: '%s'\n", impact_element->string);

            for (cvss_data = impact_element->child; cvss_data; cvss_data = cvss_data->next) {
                printf ("cvss_data '%s': '%s'\n", cvss_data->string, cvss_data->valuestring);

                if (!strcmp(cvss_data->string, "version")) {
                    if (!strcmp(cvss_data->valuestring, "2.0")) {
                        data->cvss2 = scoring;
                    } else if (!strcmp(cvss_data->valuestring, "3.0")) {
                        data->cvss3 = scoring;
                    }
                    os_strdup(cvss_data->valuestring, scoring->version);
                } else if (!strcmp(cvss_data->string, "vectorString")) {
                    scoring->vector_string = cvss_data->valuestring;
                } else if (!strcmp(cvss_data->string, "baseScore")) {
                    scoring->base_score = cvss_data->valuedouble;
                }
            }
            if (!strcmp(impact_element->string, "exploitabilityScore")) {
                scoring->exploitability_score = impact_element->valuedouble;
            } else if (!strcmp(impact_element->string, "impactScore")) {
                scoring->impact_score = impact_element->valuedouble;
            }
        }
    }

    return 0;
}

int main() {
    printf("Generating NVD database\n");
    cJSON *nvd_json;
    pnvd nvd_2013;

    nvd_database_create();
    if (nvd_json = read_nvd_file(), nvd_json) {
        nvd_2013 = parse_nvd_json(nvd_json);
    } else {
        printf("Error reading json\n");
    }

    return 0;
}