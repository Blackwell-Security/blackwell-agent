#include "../external/wazuh_tools.h"

#define MAX_SIZE 6144
#define NVD_DB "vuln.db"

/* Data structure
 *
 * All nvd structures are linked list
 *
 */
typedef struct nvd_references {
    char *url;
    char *refsource;
    struct nvd_references *next;
} nvd_references;

typedef struct nvd_conf_cpe_match {
    int vulnerable;
    char *cpe_uri23;
    char *version_start_including;
    char *version_start_excluding;
    char *version_end_including;
    char *version_end_excluding;
    cpe *cpe_node;
    struct nvd_conf_cpe_match *next;
} nvd_conf_cpe_match;

typedef struct nvd_configuration {
    char *operator;
    struct nvd_configuration *children;
    nvd_conf_cpe_match *cpe_matches;
    struct nvd_configuration *next;
} nvd_configuration;

typedef struct cv_scoring_system {
    char *version;
    char *vector_string;
    float base_score;
    float exploitability_score;
    float impact_score;
} cv_scoring_system;

typedef struct nvd {
    char *id;
    char *cwe;
    char *description;
    nvd_references *references;
    nvd_configuration *configuration;
    cv_scoring_system *cvss2;
    cv_scoring_system *cvss3;
    char *published;
    char *last_modified;
    struct nvd *next;
} nvd;

//SQL Queries
typedef enum nvd_name_query {
    INSERT_NVD_METADATA,
    INSERT_NVD_CVE,
    INSERT_NVD_METRIC_CVSS,
    INSERT_NVD_REFERENCE,
    INSERT_NVD_CVE_CONFIGURATION,
    INSERT_NVD_CVE_MATCH,
    INSERT_NVD_CPE,
    INSERT_NVD_MATCH_CPE,
    GET_MAX_NVD_CVE_ID,
    GET_MIN_NVD_CVE_ID,
    GET_MAX_CONFIGURATION_ID,
    GET_MIN_CONFIGURATION_ID,
    GET_MAX_NVD_CPE_ID,
    GET_MIN_NVD_CPE_ID
} nvd_name_query;


static const char *nvd_query[] = {
    "INSERT INTO NVD_METADATA VALUES(null,?,?,?,?,?);",
    "INSERT INTO NVD_CVE VALUES(null,?,?,?,?,?,?);",
    "INSERT INTO NVD_METRIC_CVSS VALUES(null,?,?,?,?,?,?);",
    "INSERT INTO NVD_REFERENCE VALUES(null,?,?,?);",
    "INSERT INTO NVD_CVE_CONFIGURATION VALUES(null,?,?);",
    "INSERT INTO NVD_CVE_MATCH VALUES(null,?,?,?,?,?,?,?);",
    "INSERT INTO NVD_CPE VALUES(?,?,?,?,?,?,?,?,?,?,?);",
    "INSERT INTO NVD_MATCH_CPE VALUES(?,?);",
    "SELECT MAX(ID) FROM NVD_CVE;",
    "SELECT MIN(ID) FROM NVD_CVE;",
    "SELECT MAX(ID) FROM NVD_CVE_CONFIGURATION;",
    "SELECT MIN(ID) FROM NVD_CVE_CONFIGURATION;",
    "SELECT MAX(_ROWID_) FROM NVD_CPE;",
    "SELECT MIN(_ROWID_) FROM NVD_CPE;"
};

extern const char *cpe_schema;

// Function declaration
cJSON * read_nvd_file();
int nvd_database_create();
nvd * parse_nvd_json(cJSON *nvd_json);
int parse_nvd_cve(cJSON *cve, nvd *data);
int parse_nvd_configuration(cJSON *configuration, nvd *data);
int parse_nvd_configuration_node(cJSON *conf_element, nvd_configuration *conf);
int parse_nvd_impact(cJSON *impact, nvd *data);

int nvd_fill_database(nvd *nvd_data);
int insert_nvd_metadata(sqlite3 *db, nvd *nvd_data);
int insert_nvd_cve(sqlite3 *db, nvd *nvd_data);
int insert_nvd_cve_metric_cvss(sqlite3 *db, cv_scoring_system *nvd_data, int node_id);
int insert_nvd_cve_configuration(sqlite3 *db, nvd_configuration *nvd_data, int node_id);
int insert_nvd_cve_match(sqlite3 *db, nvd_conf_cpe_match *nvd_data, int conf_id);
int insert_nvd_cve_references(sqlite3 *db, nvd_references *nvd_data, int node_id);
int insert_nvd_cve_cpe(sqlite3 *db, cpe *cpe_data, int conf_id);
int insert_nvd_cve_match_cpe(sqlite3 *db, int conf_id, int cve_id);

void free_nvd_references(nvd_references *data);
void free_nvd_conf_cpe_match(nvd_conf_cpe_match *data);
void free_nvd_configuration(nvd_configuration *data);
void free_cv_scoring_system(cv_scoring_system *data);
void free_nvd_node(nvd *data);
void free_nvd(nvd *data);


//Cleaning structures
void free_nvd_references(nvd_references *data) {
    nvd_references *node;

    while (data) {
        node = data->next;
        os_free(data->url);
        os_free(data->refsource);
        os_free(data);
        data = node;
    }
}

void free_nvd_conf_cpe_match(nvd_conf_cpe_match *data) {
    nvd_conf_cpe_match *node;

    while (data) {
        node = data->next;
        os_free(data->cpe_uri23);
        os_free(data->version_start_including);
        os_free(data->version_start_excluding);
        os_free(data->version_end_including);
        os_free(data->version_end_excluding);
        os_free(data);
        data = node;
    }
}

void free_nvd_configuration(nvd_configuration *data) {
    nvd_configuration *node;

    while (data) {
        node = data->next;
        free_nvd_conf_cpe_match(data->cpe_matches);
        free_nvd_configuration(data->children);
        os_free(data);
        data = node;
    }
}

void free_cv_scoring_system(cv_scoring_system *data) {
    if(data) {
        os_free(data->vector_string);
        os_free(data->version);
        os_free(data);
    }
}

void free_nvd_node(nvd *data) {
    os_free(data->id);
    os_free(data->cwe);
    os_free(data->description);
    free_nvd_references(data->references);
    free_nvd_configuration(data->configuration);
    free_cv_scoring_system(data->cvss2);
    free_cv_scoring_system(data->cvss3);
    os_free(data->published);
    os_free(data->last_modified);
    os_free(data);
}

void free_nvd(nvd *data) {
    nvd *node;

    while (data) {
        node = data->next;
        free_nvd_node(data);
        data = node;
    }
}


//Implementation
int nvd_database_create() {
    if (wm_vuldet_create_file(NVD_DB, cpe_schema)) {
        printf("Could not create the database\n");
        return -1;
    }

    return 0;
}

// Return NULL on error
cJSON * read_nvd_file() {
    cJSON *json_feed = NULL;

    if (json_feed =  json_fread("./nvdcve-1.0-2014.json", 0), !json_feed) {
        printf("Error reading nvd file\n");
        return NULL;
    }

    return json_feed;
}

nvd * parse_nvd_json(cJSON *nvd_json) {
    cJSON *nvd_data;
    cJSON *cve_list;
    cJSON *cve_data;
    nvd * nvd_list;
    nvd * nvd_node = NULL;

    os_calloc(1, sizeof(nvd), nvd_list);
    nvd_node = nvd_list;

    for (nvd_data = nvd_json->child; nvd_data; nvd_data = nvd_data->next) {
        //printf("cve_list: '%s'\n", nvd_data->string);

        if (!strcmp(nvd_data->string, "CVE_Items")) {
            for (cve_list = nvd_data->child; cve_list; cve_list = cve_list->next) {

                for (cve_data = cve_list->child; cve_data; cve_data = cve_data->next) {
                    //printf("'%s': '%s'\n", cve_data->string, cve_data->valuestring);
                    if (!strcmp(cve_data->string, "cve")) {
                        parse_nvd_cve(cve_data, nvd_node);
                    } else if (!strcmp(cve_data->string, "configurations")) {
                        parse_nvd_configuration(cve_data, nvd_node);
                    } else if (!strcmp(cve_data->string, "impact")) {
                        parse_nvd_impact(cve_data, nvd_node);
                    } else if (!strcmp(cve_data->string, "publishedDate")) {
                        os_strdup(cve_data->valuestring, nvd_node->published);
                    } else if (!strcmp(cve_data->string, "lastModifiedDate")) {
                        os_strdup(cve_data->valuestring, nvd_node->last_modified);
                    }
                }
                //printf("Reservo nvd\n\n");
                os_calloc(1, sizeof(nvd), nvd_node->next);
                nvd_node = nvd_node->next;
            }
        }
    }

    return nvd_list;
}

int parse_nvd_cve(cJSON *cves, nvd *data) {
    cJSON *cve_item;
    cJSON *cve_element;
    nvd_references *ref_node = NULL;

    os_calloc(1, sizeof(nvd_references), data->references);
    ref_node = data->references;

    for (cve_item = cves->child; cve_item; cve_item = cve_item->next) {
        //printf("parse_nvd_cve: '%s'\n", cve_item->string);
        if (!strcmp(cve_item->string, "CVE_data_meta")) {
            //printf("'%s': '%s'\n", cve_item->child->string, cve_item->child->valuestring);
            os_strdup(cve_item->child->valuestring, data->id);
        } else if (!strcmp(cve_item->string, "problemtype") && cve_item->child->child->child->child) {
            //printf ("cwe: '%s'\n", cve_item->child->child->child->child->child->next ? cve_item->child->child->child->child->child->next->valuestring : "CWE not found");
            os_strdup(cve_item->child->child->child->child->child->next->valuestring, data->cwe);
        } else if (!strcmp(cve_item->string, "references")) {
            //printf ("\nnvd_cve: '%s'\n", cve_item->string);

            for (cve_element = cve_item->child->child; cve_element; cve_element = cve_element->next) {
                //printf ("'%s': '%s'\n", cve_element->child->string, cve_element->child->valuestring);
                //printf ("'%s': '%s'\n", cve_element->child->next->next->string, cve_element->child->next->next->valuestring);
                //printf ("'%s': '%s'\n", cve_element->child->next->next->string, cve_element->child->next->next->valuestring);
                os_strdup(cve_element->child->valuestring, ref_node->url);
                os_strdup(cve_element->child->next->next->valuestring, ref_node->refsource);

                //printf("Reservo nvd_references\n\n");
                os_calloc(1, sizeof(nvd_references), ref_node->next);
                ref_node = ref_node->next;
            }
        } else if (!strcmp(cve_item->string, "description") && cve_item->child) {
            //printf ("descp: '%s'\n", cve_item->child->child->child->next ? cve_item->child->child->child->next->valuestring : "desc not found");
            os_strdup(cve_item->child->child->child->next->valuestring, data->description);
        }
    }

    return 0;
}

int parse_nvd_configuration(cJSON *nvd_item, nvd *data) {
    cJSON *conf_item;
    nvd_configuration *conf_node = NULL;

    //printf("Reservo nvd_configuration\n\n");
    os_calloc(1, sizeof(nvd_configuration), data->configuration);
    conf_node = data->configuration;

    for (conf_item = nvd_item->child; conf_item; conf_item = conf_item->next) {
        //printf ("conf_item: '%s'\n", conf_item->string);
        if (!strcmp(conf_item->string, "nodes")) {
            parse_nvd_configuration_node(conf_item, data->configuration);
        }
    }

    return 0;
}

int parse_nvd_configuration_node(cJSON *configurations, nvd_configuration *conf) {
    cJSON *conf_element;
    cJSON *conf_node;
    cJSON *cpe_match_item;
    cJSON *cpe_match_element;
    nvd_configuration *cve_conf_node = NULL;
    nvd_conf_cpe_match *cpe_match_node = NULL;

    cve_conf_node = conf;

    for (conf_element = configurations->child; conf_element; conf_element = conf_element->next) {
        //printf("'%s': '%s'\n", conf_element->string, conf_element->valuestring);

        for (conf_node = conf_element->child; conf_node; conf_node = conf_node->next) {
            //printf("'%s': '%s'\n", conf_node->string, conf_node->valuestring);

            if (!strcmp(conf_node->string, "operator")) {
                //printf("operator: '%s'\n", conf_node->child->valuestring);
                cve_conf_node->operator = conf_node->valuestring;
            } else if (!strcmp(conf_node->string, "children")) {
                //Parsing AND node
                //printf("Reservo nvd_configuration children\n\n");
                os_calloc(1, sizeof(nvd_configuration), cve_conf_node->children);
                cve_conf_node->children->operator = conf_node->valuestring;
                parse_nvd_configuration_node(conf_node, cve_conf_node->children);
            } else if (!strcmp(conf_node->string, "cpe_match")) {

                for (cpe_match_item = conf_node->child; cpe_match_item; cpe_match_item = cpe_match_item->next) {

                    if (cve_conf_node->cpe_matches == NULL) {
                        //printf("Reservo nvd_conf_cpe_match\n\n");
                        os_calloc(1, sizeof(nvd_conf_cpe_match), cve_conf_node->cpe_matches);
                        cpe_match_node = cve_conf_node->cpe_matches;
                    } else {
                        //printf("Reservo nvd_conf_cpe_match next\n\n");
                        os_calloc(1, sizeof(nvd_conf_cpe_match), cpe_match_node->next);
                        cpe_match_node = cpe_match_node->next;
                    }

                    for(cpe_match_element = cpe_match_item->child; cpe_match_element; cpe_match_element = cpe_match_element->next) {
                        //printf ("'%s': '%s'\n", cpe_match_element->string, cpe_match_element->valuestring);

                        if (!strcmp(cpe_match_element->string, "vulnerable")) {
                            cpe_match_node->vulnerable = cpe_match_element->valueint;
                        } else if (!strcmp(cpe_match_element->string, "cpe23Uri")) {
                            os_strdup(cpe_match_element->valuestring, cpe_match_node->cpe_uri23);
                            cpe_match_node->cpe_node = decode_cpe(cpe_match_node->cpe_uri23 + strlen("cpe:2.3:"));
                        } else if (!strcmp(cpe_match_element->string, "versionStartIncluding")) {
                            os_strdup(cpe_match_element->valuestring, cpe_match_node->version_start_including);
                        } else if (!strcmp(cpe_match_element->string, "versionEndIncluding")) {
                            os_strdup(cpe_match_element->valuestring, cpe_match_node->version_end_including);
                        } else if (!strcmp(cpe_match_element->string, "versionStartExcluding")) {
                            os_strdup(cpe_match_element->valuestring, cpe_match_node->version_start_excluding);
                        } else if (!strcmp(cpe_match_element->string, "versionEndExcluding")) {
                            os_strdup(cpe_match_element->valuestring, cpe_match_node->version_end_excluding);
                        }
                    }
                }
            }
        }
        os_calloc(1, sizeof(nvd_configuration), cve_conf_node->next);
        cve_conf_node = cve_conf_node->next;
    }

    return 0;
}

int parse_nvd_impact(cJSON *nvd_item, nvd *data) {
    cJSON *impact_item;
    cJSON *impact_element;
    cJSON *cvss_data;
    cv_scoring_system * scoring;

    for (impact_item = nvd_item->child; impact_item; impact_item = impact_item->next) {
        //printf("\nimpact_item: '%s'\n", impact_item->string);

        for (impact_element = impact_item->child; impact_element; impact_element = impact_element->next) {
            //printf("impact_element: '%s'\n", impact_element->string);
            for (cvss_data = impact_element->child; cvss_data; cvss_data = cvss_data->next) {
                //printf("cvss_data '%s': '%s'\n", cvss_data->string, cvss_data->valuestring);

                if (!strcmp(cvss_data->string, "version")) {
                    if (!strcmp(cvss_data->valuestring, "2.0")) {
                        //printf("Reservo cv_scoring\n");
                        os_calloc(1, sizeof(cv_scoring_system), scoring);
                        data->cvss2 = scoring;
                    } else if (!strcmp(cvss_data->valuestring, "3.0")) {
                        //printf("Reservo cv_scoring\n");
                        os_calloc(1, sizeof(cv_scoring_system), scoring);
                        data->cvss3 = scoring;
                    }
                    os_strdup(cvss_data->valuestring, scoring->version);
                } else if (!strcmp(cvss_data->string, "vectorString")) {
                    os_strdup(cvss_data->valuestring, scoring->vector_string);
                } else if (!strcmp(cvss_data->string, "baseScore")) {
                    scoring->base_score = cvss_data->valuedouble;
                }
            }

            if (!strcmp(impact_element->string, "exploitabilityScore")) {
                scoring->exploitability_score = impact_element->valuedouble;
            } else if (!strcmp(impact_element->string, "impactScore")) {
                scoring->impact_score = impact_element->valuedouble;
            }
        }
    }

    return 0;
}

int insert_nvd_cve_references(sqlite3 *db, nvd_references *nvd_data, int node_id) {
    nvd_references *node;
    sqlite3_stmt *stmt = NULL;
    int result;

    node = nvd_data;
    while(node && node->url) {
        if (sqlite3_prepare_v2(db, nvd_query[INSERT_NVD_REFERENCE], -1, &stmt, NULL) != SQLITE_OK) {
            return wm_vuldet_sql_error(db, stmt);
        }
        sqlite3_bind_int(stmt, 1, node_id);
        sqlite3_bind_text(stmt, 2, node->url, -1, NULL);
        sqlite3_bind_text(stmt, 3, node->refsource, -1, NULL);

        if (result = wm_vuldet_step(stmt), result != SQLITE_DONE && result != SQLITE_CONSTRAINT) {
            return wm_vuldet_sql_error(db, stmt);
        }
        sqlite3_finalize(stmt);
        node = node->next;
    }

    return result;
}


int insert_nvd_cve_cpe(sqlite3 *db, cpe *cpe_data, int conf_id) {
    nvd_conf_cpe_match *node;
    sqlite3_stmt *stmt = NULL;
    int result;
    int cve_id = 0;

    if (sqlite3_prepare_v2(db, nvd_query[INSERT_NVD_CPE], -1, &stmt, NULL) != SQLITE_OK) {
        return wm_vuldet_sql_error(db, stmt);
    }
    sqlite3_bind_text(stmt, 1, cpe_data->part, -1, NULL);
    sqlite3_bind_text(stmt, 2, cpe_data->vendor, -1, NULL);
    sqlite3_bind_text(stmt, 3, cpe_data->product, -1, NULL);
    sqlite3_bind_text(stmt, 4, cpe_data->version, -1, NULL);
    sqlite3_bind_text(stmt, 5, cpe_data->update, -1, NULL);
    sqlite3_bind_text(stmt, 6, cpe_data->edition, -1, NULL);
    sqlite3_bind_text(stmt, 7, cpe_data->language, -1, NULL);
    sqlite3_bind_text(stmt, 8, cpe_data->sw_edition, -1, NULL);
    sqlite3_bind_text(stmt, 9, cpe_data->target_sw, -1, NULL);
    sqlite3_bind_text(stmt, 10, cpe_data->target_hw, -1, NULL);
    sqlite3_bind_text(stmt, 11, cpe_data->other, -1, NULL);

    if (result = wm_vuldet_step(stmt), result != SQLITE_DONE && result != SQLITE_CONSTRAINT) {
        return wm_vuldet_sql_error(db, stmt);
    }
    sqlite3_finalize(stmt);

    if (sqlite3_prepare_v2(db, nvd_query[GET_MAX_NVD_CPE_ID], -1, &stmt, NULL) != SQLITE_OK) {
        return wm_vuldet_sql_error(db, stmt);
    }

    if (result = wm_vuldet_step(stmt), result != SQLITE_ROW) {
        return wm_vuldet_sql_error(db, stmt);
    }

    if (cve_id = sqlite3_column_int(stmt, 0), cve_id > 0) {
        insert_nvd_cve_match_cpe(db, conf_id, cve_id);
    } else {
        printf("Error getting cve_id row\n");
        result = -1;
    }
    sqlite3_finalize(stmt);

    return result;
}

int insert_nvd_cve_match_cpe(sqlite3 *db, int conf_id, int cve_id) {
    nvd_conf_cpe_match *node;
    sqlite3_stmt *stmt = NULL;
    int result;

    if (sqlite3_prepare_v2(db, nvd_query[INSERT_NVD_MATCH_CPE], -1, &stmt, NULL) != SQLITE_OK) {
        return wm_vuldet_sql_error(db, stmt);
    }
    sqlite3_bind_int(stmt, 1, conf_id);
    sqlite3_bind_int(stmt, 2, cve_id);

    if (result = wm_vuldet_step(stmt), result != SQLITE_DONE && result != SQLITE_CONSTRAINT) {
        return wm_vuldet_sql_error(db, stmt);
    }
    sqlite3_finalize(stmt);

    return result;
}

int insert_nvd_cve_match(sqlite3 *db, nvd_conf_cpe_match *nvd_data, int conf_id) {
    nvd_conf_cpe_match *node;
    sqlite3_stmt *stmt = NULL;
    int result;

    node = nvd_data;
    while(node) {
        if (sqlite3_prepare_v2(db, nvd_query[INSERT_NVD_CVE_MATCH], -1, &stmt, NULL) != SQLITE_OK) {
            return wm_vuldet_sql_error(db, stmt);
        }
        sqlite3_bind_int(stmt, 1, conf_id);
        sqlite3_bind_int(stmt, 2, node->vulnerable);
        sqlite3_bind_text(stmt, 3, node->cpe_uri23, -1, NULL);
        sqlite3_bind_text(stmt, 4, node->version_start_including, -1, NULL);
        sqlite3_bind_text(stmt, 5, node->version_start_excluding, -1, NULL);
        sqlite3_bind_text(stmt, 6, node->version_end_including, -1, NULL);
        sqlite3_bind_text(stmt, 7, node->version_end_excluding, -1, NULL);

        if (result = wm_vuldet_step(stmt), result != SQLITE_DONE && result != SQLITE_CONSTRAINT) {
            return wm_vuldet_sql_error(db, stmt);
        }
        sqlite3_finalize(stmt);
        insert_nvd_cve_cpe(db, nvd_data->cpe_node, conf_id);
        node = node->next;
    }

    return result;
}

int insert_nvd_cve_configuration(sqlite3 *db, nvd_configuration *nvd_data, int node_id) {
    nvd_configuration *node;
    sqlite3_stmt *stmt = NULL;
    int result;
    int id_cve_conf = 0;

    if(nvd_data->children) {
        insert_nvd_cve_configuration(db, nvd_data->children, node_id);
    }

    node = nvd_data;
    while(node && node->operator) {
        if (sqlite3_prepare_v2(db, nvd_query[INSERT_NVD_CVE_CONFIGURATION], -1, &stmt, NULL) != SQLITE_OK) {
            return wm_vuldet_sql_error(db, stmt);
        }
        sqlite3_bind_int(stmt, 1, node_id);
        sqlite3_bind_text(stmt, 2, node->operator, -1, NULL);

        if (result = wm_vuldet_step(stmt), result != SQLITE_DONE && result != SQLITE_CONSTRAINT) {
            return wm_vuldet_sql_error(db, stmt);
        }
        sqlite3_finalize(stmt);

        if (sqlite3_prepare_v2(db, nvd_query[GET_MAX_CONFIGURATION_ID], -1, &stmt, NULL) != SQLITE_OK) {
            return wm_vuldet_sql_error(db, stmt);
        }

        if (result = wm_vuldet_step(stmt), result != SQLITE_ROW) {
            return wm_vuldet_sql_error(db, stmt);
        }

        if (id_cve_conf = sqlite3_column_int(stmt, 0), id_cve_conf > 0) {
            insert_nvd_cve_match(db, node->cpe_matches, id_cve_conf);
        } else {
            printf("Error getting id_cve_conf row\n");
            result = -1;
        }
        sqlite3_finalize(stmt);
        node = node->next;
    }

    return result;
}

int insert_nvd_cve_metric_cvss(sqlite3 *db, cv_scoring_system *nvd_data, int node_id) {
    cv_scoring_system *node;
    sqlite3_stmt *stmt = NULL;
    int result;

    if (sqlite3_prepare_v2(db, nvd_query[INSERT_NVD_METRIC_CVSS], -1, &stmt, NULL) != SQLITE_OK) {
        return wm_vuldet_sql_error(db, stmt);
    }

    sqlite3_bind_int(stmt, 1, node_id);
    sqlite3_bind_text(stmt, 2, nvd_data->version, -1, NULL);
    sqlite3_bind_text(stmt, 3, nvd_data->vector_string, -1, NULL);
    sqlite3_bind_int(stmt, 4, nvd_data->base_score);
    sqlite3_bind_int(stmt, 5, nvd_data->exploitability_score);
    sqlite3_bind_int(stmt, 6, nvd_data->impact_score);

    if (result = wm_vuldet_step(stmt), result != SQLITE_DONE && result != SQLITE_CONSTRAINT) {
        return wm_vuldet_sql_error(db, stmt);
    }
    sqlite3_finalize(stmt);

    return 0;
}

int insert_nvd_cve(sqlite3 *db, nvd *nvd_data) {
    nvd *node;
    sqlite3_stmt *stmt = NULL;
    int result;
    int id_nvd_cve = 0;

    node = nvd_data;
    if (sqlite3_prepare_v2(db, nvd_query[INSERT_NVD_CVE], -1, &stmt, NULL) != SQLITE_OK) {
        return wm_vuldet_sql_error(db, stmt);
    }

    sqlite3_bind_int(stmt, 1, 2012);
    sqlite3_bind_text(stmt, 2, node->id, -1, NULL);
    sqlite3_bind_text(stmt, 3, node->cwe, -1, NULL);
    sqlite3_bind_text(stmt, 4, node->description, -1, NULL);
    sqlite3_bind_text(stmt, 5, node->published, -1, NULL);
    sqlite3_bind_text(stmt, 6, node->last_modified, -1, NULL);

    if (result = wm_vuldet_step(stmt), result != SQLITE_DONE && result != SQLITE_CONSTRAINT) {
        return wm_vuldet_sql_error(db, stmt);
    }
    sqlite3_finalize(stmt);

    if (sqlite3_prepare_v2(db, nvd_query[GET_MAX_NVD_CVE_ID], -1, &stmt, NULL) != SQLITE_OK) {
        return wm_vuldet_sql_error(db, stmt);
    }

    if (result = wm_vuldet_step(stmt), result != SQLITE_ROW) {
        return wm_vuldet_sql_error(db, stmt);
    }

    if (id_nvd_cve = sqlite3_column_int(stmt, 0), id_nvd_cve > 0) {
        //printf("id_nvd_cve: %d\n", id_nvd_cve);
        if (nvd_data->references) {
            insert_nvd_cve_references(db, nvd_data->references, id_nvd_cve);
        }
        if (nvd_data->configuration) {
            insert_nvd_cve_configuration(db, nvd_data->configuration, id_nvd_cve);
        }
        if (nvd_data->cvss2) {
            insert_nvd_cve_metric_cvss(db, nvd_data->cvss2, id_nvd_cve);
        }
        if (nvd_data->cvss3) {
            insert_nvd_cve_metric_cvss(db, nvd_data->cvss3, id_nvd_cve);
        }
    } else {
        printf("Error getting id_nvd_cve row\n");
        result = -1;
    }

    sqlite3_finalize(stmt);

    return result;
}

int insert_nvd_metadata(sqlite3 *db, nvd *nvd_data) {

    return 0;
}

int nvd_fill_database(nvd *nvd_data) {
    nvd *node;
    sqlite3 *db;
    sqlite3_stmt *stmt = NULL;

    if (sqlite3_open_v2(NVD_DB, &db, SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE, NULL)) {
        return wm_vuldet_sql_error(db, stmt);
    }

    sqlite3_exec(db, vu_queries[BEGIN_T], NULL, NULL, NULL);
    node = nvd_data;

    //insert_nvd_metadata(nvd_data);

    while(node) {
        insert_nvd_cve(db, node);
        node = node->next;
    }

    sqlite3_exec(db, vu_queries[END_T], NULL, NULL, NULL);
    sqlite3_close_v2(db);

    return 0;
}


int main() {
    printf("Generating NVD database\n");
    cJSON *nvd_json;
    nvd *nvd_2013;
    nvd *node;

    nvd_database_create();
    if (nvd_json = read_nvd_file(), nvd_json) {
        nvd_2013 = parse_nvd_json(nvd_json);
        nvd_fill_database(nvd_2013);

        // node = nvd_2013;
        // while(node) {
        //     printf("cve_id: '%s'\n", node->id);
        //     node = node->next;
        // }

        cJSON_Delete(nvd_json);
        free_nvd(nvd_2013);
    } else {
        printf("Error reading json\n");
    }


    return 0;
}