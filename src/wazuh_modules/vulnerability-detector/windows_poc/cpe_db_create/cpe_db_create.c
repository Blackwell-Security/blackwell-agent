#include "../external/wazuh_tools.h"

#define MAX_SIZE 6144

extern const char *cpe_schema;

// Functions
int read_cpe_database(char *cpe_raw);

// Globals
cpe_list *listcpe;

int read_cpe_database(char *cpe_raw) {
    FILE *fp;
    char buffer[MAX_SIZE + 1];
    static char *cpe_header = "-item name=\"cpe:2.";
    size_t cpe_header_size = strlen(cpe_header);
    char *cpe_found;
    cpe_list node_list = {0};

    if (fp = fopen(cpe_raw, "r"), !fp) {
        return 1;
    }

    while (fgets(buffer, MAX_SIZE, fp)) {
        if (cpe_found = strstr(buffer, cpe_header), cpe_found) {
            char *cpe_end;
            cpe_found += cpe_header_size;
            if (cpe_found = strchr(cpe_found, ':'), cpe_found) {
                if (cpe_end = wstr_chr(++cpe_found, '"'), cpe_end) {
                    *cpe_end = '\0';
                    if (add_cpe(cpe_found, &node_list, 0)) {
                        printf("Error parsing cpe line '%s'\n", buffer);
                    }
                }
            }
        }
    }

    fclose(fp);
    if (insert_cpe_db(&node_list, 1)){
        printf("Could not insert the CPEs in the database.\n");
        return 1;
    }

    return 0;
}

int main(int argc, char *argv[])
{
    if (wm_vuldet_create_file(CPE_DB, cpe_schema)) {
        printf("Could not create the database.\n");
        return 1;
    }

    if (read_cpe_database(argv[1])) {
        printf("Could not generate the CPE database.\n");
        return 1;
    }

    return 0;
}
