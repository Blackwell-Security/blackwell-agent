#ifndef W_TOOLS
#define W_TOOLS
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>
#include <stdio.h>
#include <sys/socket.h>
#include <stdlib.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <sys/un.h>
#include <sys/stat.h>
#include <unistd.h>
#include <netdb.h>
#include "sqlite/sqlite3.h"
#include "cJSON/cJSON.h"
#include "os_net/os_net.h"
#include "fcntl.h"

#define os_strdup(x,y) ((y = strdup(x)))?(void)1:exit(1)
#define os_calloc(x,y,z) ((z = (__typeof__(z)) calloc(x,y)))?(void)1:exit(1)
#define OS_INVALID 1
#define OS_SOCKTERR -6
#define OS_CONNERR -8
#define OS_SOCKBUSY -11
#define OS_MAXLEN -12
#define OS_MAXSTR 66666
#define BACKLOG 128
#define WM_VULNDETECTOR_LOGTAG "vuln-det"
#define OS_SIZE_6144 6144
#define OS_SIZE_1024 1024
#define VU_MAX_PACK_REQ 40
#define MAX_DYN_STR 4194304
#define DEFAULTDIR "/var/ossec"
#define WDB_LOCAL_SOCK "/queue/db/wdb"
#define WDB_LOCAL_SOCK_PATH DEFAULTDIR WDB_LOCAL_SOCK

typedef enum vu_query {
    VU_SOFTWARE_REQUEST,
    VU_SOFTWARE_FULL_REQ,
    VU_INSERT_CPE,
    BEGIN_T,
    END_T,
    VU_REMOVE_CPE,
    VU_INSERT_AGENTS,
    VU_SYSC_UPDATE_SCAN,
    VU_SYSC_SCAN_REQUEST
} vu_query;

static const char *vu_queries[] = {
    "agent %s sql SELECT DISTINCT NAME, VERSION, ARCHITECTURE, VENDOR FROM SYS_PROGRAMS WHERE TRIAGED = 0 AND SCAN_ID = '%s' LIMIT %i OFFSET %i;", // ~~~~~~~~~~~ Change on vuln
    "agent %s sql SELECT DISTINCT NAME, VERSION, ARCHITECTURE, VENDOR FROM SYS_PROGRAMS WHERE SCAN_ID = '%s' LIMIT %i OFFSET %i;", // ~~~~~~~~~~~ Change on vuln
    "INSERT INTO CPE_INDEX VALUES(null,?,?,?,?,?,?,?,?,?,?,?,0);",
    "BEGIN;",
    "END;",
    "DELETE FROM CPE_INDEX;",
    "INSERT INTO AGENTS VALUES(?,0,?,?,?,?);", // ~~~~~~~~~~~ Change on vuln
    "agent %s sql UPDATE SYS_PROGRAMS SET TRIAGED = 1 WHERE SCAN_ID = '%s';",
    "agent %s sql SELECT SCAN_ID FROM SYS_PROGRAMS WHERE SCAN_TIME = (SELECT SCAN_TIME FROM SYS_PROGRAMS S1 WHERE NOT EXISTS (SELECT SCAN_TIME FROM SYS_PROGRAMS S2 WHERE S2.SCAN_TIME > S1.SCAN_TIME)) LIMIT 1;"
};

typedef struct last_scan {
    char *last_scan_id;
    time_t last_scan_time;
} last_scan;

typedef struct agent_software {
    char *agent_id;
    char *agent_name;
    char *agent_ip;
    char *agent_OS;
    char *arch;
    char info;
    struct agent_software *next;
    struct agent_software *prev;
} agent_software;

char * wstr_chr(char * str, int character);
char *os_strip_char(const char *source, char remove);
int wm_vuldet_sql_error(sqlite3 *db, sqlite3_stmt *stmt);
int wm_vuldet_create_file(const char *path, const char *source);
int wm_vuldet_step(sqlite3_stmt *stmt);
int wm_vuldet_get_software_info(agent_software *agent, sqlite3 *db, int agents_triag, unsigned long ignore_time);

#endif
