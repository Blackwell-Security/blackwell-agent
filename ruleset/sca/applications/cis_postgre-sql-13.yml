# Security Configuration Assessment
# CIS Checks for PostgreSQL 13
# Copyright (C) 2015-2021, Wazuh Inc.
#
# This program is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public
# License (version 2) as published by the FSF - Free Software
# Foundation
#
# Based on:
# Center for Internet Security Benchmark for PostgreSQL 13 Benchmark v1.0.0 - 02-26-2021

policy:
  id: "cis_postgresql_13"
  file: "cis_postgre-sql-13.yml"
  name: "CIS Benchmark for PostgreSQL 13"
  description: "This document, CIS PostgreSQL 13 Benchmark, provides prescriptive guidance for
    establishing a secure configuration posture for PostgreSQL 13."
  references:
    - https://www.cisecurity.org/cis-benchmarks/

requirements: asdf

checks:
# 1 Installation and Patches
# 1.2 Ensure systemd Service Files Are Enabled (Automated)
  - id: 24000
    title: Ensure systemd Service Files Are Enabled
    description: Confirm, and correct if necessary, the PostgreSQL systemd service is enabled.
    rationale: Enabling the systemd service on the OS ensures the database service is active when a
      change of state occurs as in the case of a system startup or reboot.
    remediation: Irrespective of package source, PostgreSQL services can be identified because it typically
      includes the text string "postgresql". PGDG installs do not automatically register the service
      as a "want" of the default systemd target. Multiple instances of PostgreSQL services often
      distinguish themselves using a version number.
    compliance:
      - cis: ["1.2"]
      - cis_csc: ["18, "5.1"]
    references:
      - https://linuxcommand.org/man_pages/runlevel8.html
      - https://linuxcommand.org/man_pages/chkconfig8.html
      - https://www.tldp.org/LDP/sag/html/run-levels-intro.html
    condition: all
    rules:
      - "c: systemctl get-default | systemctl list-dependencies $default_tmp | grep -i postgres -> r:.+"

# 1.3 Ensure Data Cluster Initialized Successfully (Automated)
  - id: 24001
    title: Ensure Data Cluster Initialized Successfully
    description: First time installs of PostgreSQL requires the instantiation of the database cluster. A
      database cluster is a collection of databases that are managed by a single server instance.
    rationale:

# 3 Logging Monitoring And Auditing
# 3.1.2 Ensure the log destinations are set correctly (Automated)
  - id: 24002
    title: Ensure the log destinations are set correctly
    description: PostgreSQL supports several methods for logging server messages, including stderr,
      csvlog and syslog. On Windows, eventlog is also supported. One or more of these
      destinations should be set for server log output.
    rationale: If log_destination is not set, then any log messages generated by the core PostgreSQL
      processes will be lost.
    remediation: "Execute the following SQL statements to remediate this setting (in this example, setting the
      log destination to csvlog):
      postgres=# alter system set log_destination = 'csvlog';
      ALTER SYSTEM
      postgres=# select pg_reload_conf();
      pg_reload_conf
      ----------------
      t
      (1 row)"
